name: Deploy to Platform.sh main

on:
  workflow_dispatch:

jobs:
  check-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - uses: actions/setup-python@v5
      - uses: snok/install-poetry@v1
      - name: Check Poetry dependencies
        run: poetry show -o

  check-migrations:
    name: Check Migrations
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - name: Run tests
        uses: ./.github/actions/check-migrations

  test-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - name: Run tests
        uses: ./.github/actions/python-tests

  deploy:
    environment:
      name: beta
      url: https://beta.nationalarchives.gov.uk
    runs-on: ubuntu-latest
    needs:
      - test-python
      - check-migrations
      - check-dependencies
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
      - uses: axelerant/platformsh-deploy-action@v1
        with:
          project-id: ${{ secrets.PLATFORM_PROJECT_ID }}
          cli-token: ${{ secrets.PLATFORM_CLI_TOKEN }}
          ssh-private-key: ${{ secrets.PLATFORM_SSH_KEY }}
          force-push: true
          environment-name: main

  notify-slack:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_TITLE: "A deployment to main is complete"
